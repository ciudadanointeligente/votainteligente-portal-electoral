{% load staticfiles %}
{% load votainteligente_extras %}
{% load i18n %}
{% load thumbnail %}
<script type="text/javascript">
    $(function(){
        $('.loadFromUrl').on('show.bs.modal', function (event) {
          var anchor = $(event.relatedTarget) // Button that triggered the modal
          var modal = $(this)
          var body = modal.find('.modal-body');
          body.load(anchor.data('url'));
        })
        $('[data-toggle="tooltip"]').tooltip();
    });

var unlike_proposal = function(url){
    $.post(url, function(data){
        location.reload();
    })
};
$(function(){
    $('.unlike_proposal').click(function(event){
        event.preventDefault();
        var target = $(event.target);
        var url = target.parent().attr('href');
        unlike_proposal(url);
    })
});
</script>
<div class="apoyo">
    <div class="apoyo-btn pull-left">
        {% if not is_embedded %}
            {% if user.is_authenticated %}
                {% if user|is_candidate %}
                    {% for candidacy in user.candidacies.all %}
                        {% get_commitment candidacy proposal as commitment %}
                        {% if commitment %}
                            {% if commitment.commited %}<!-- El candidato es terrible de pulento y nos dijo que si-->
                            <a class="btn btn-success" href="{{commitment.get_absolute_url}}" role="button"  data-toggle="tooltip"
                                data-placement="top"
                                title="Te comprometiste =). Puedes revisar tu compromiso acá"><i class="fa fa-star" aria-hidden="true"></i>
                            </a>    
                            {% else %}<!-- El candidato no está ni ahí con nosotros-->                            
                            <a class="btn btn-danger" href="{{commitment.get_absolute_url}}" role="button"  data-toggle="tooltip"
                                data-placement="top"
                                title="Dijiste que NO a esta propuesta y puedes revisar tu justificación acá"><i class="fa fa-thumbs-down" aria-hidden="true"></i>
                            </a>    
                            {% endif %}
                        {% else %}<!-- Si es que el candidato no se ha pronunciado -->
                        <a class="btn btn-default" href="{{proposal.get_absolute_url}}" role="button">Yo quiero {% if candidacy.candidate.election.position == 'concejal' %}apoyar{% elif candidacy.candidate.election.position == 'alcalde' %}comprometerme{% else %}comprometerme{% endif %}</a>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% if not user|likes:proposal %}
                        {% url 'popular_proposals:like_a_proposal' pk=proposal.id as like_this_proposal_url %}
                        {% with "supportProposal"|add:proposal.slug as modalid %}
                        <a class="btn-apoyo" data-toggle="modal" data-target="#{{modalid}}">
                            {% blocktrans %}
                              <span class="fa-stack fa-2x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-heart fa-stack-1x fa-inverse"></i>
                              </span>
                            {% endblocktrans %}
                        </a>
                        {% include 'modal_like_proposal.html' with modalId=modalid title='Apoya una propuesta' url=like_this_proposal_url next_url=request.path %}
                        {% endwith %}
                        {% else %}
                        {% with  user|support:proposal as support %}
                            <a class="unlike_proposal" href="{% url 'popular_proposals:unlike_proposal' pk=support.id %}" data-toggle="tooltip" data-placement="top" title="Ya no quiero apoyar esta propuesta"><img src="{% static 'img/adherido.svg' %}"></a>
                        {% endwith %}
                        {% endif %}
                {% endif %}
                
            {% else %}
                <a class="btn btn-md btn-success full-width"  href="{% url 'auth_login' %}">
                    {% blocktrans %}<i class="fa fa-heart" aria-hidden="true"></i>{% endblocktrans %}
                </a>

            {% endif %}
        {% else %}
        <a class="btn-apoyo" href="{{proposal.get_absolute_url}}">
            {% blocktrans %}
              <span class="fa-stack fa-2x">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-heart fa-stack-1x fa-inverse"></i>
              </span>
            {% endblocktrans %}
        </a>
        {% endif %}
    </div>
    <div class="apoyo-contador">
    <!-- @camargozzini compañera acá le va el contador de quién se compromete
    el tag commiters_by_election_position devuelve una lista de candidatos que se han comprometido con una propuesta
    entonces como es una lista puedes hacer algo así
    {% comment %}
    {% commiters_by_election_position proposal 'alcalde' as alcaldes %}
    {% for candidate in alcaldes %}
    El candidato {{candidate}} es terrible de pulento y se comprometió con la propuesta. Acá sólo aparecen aquellos candidatos que dijeron que si, los otros no aparecen.
    {% endfor %}
    {% endcomment %}
    -->
            <p class="nota">{{proposal.likers.count}} ciudadanos apoyan esta propuesta</p>
            {% commiters_by_election_position proposal 'alcalde' as alcaldes %}
            {% if alcaldes.all %}
            <p class="nota">{{alcaldes.count}} candidatos a la alcaldía se han comprometido con esta propuesta</p>
            {% endif %}
            {% commiters_by_election_position proposal 'concejal' as concejales %}
            {% if concejales.all %}
                <p class="nota">{{concejales.count}} candidatos a concejal apoyan esta propuesta</p>
            {% endif %}
    </div>
</div>
